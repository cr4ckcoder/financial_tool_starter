<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Tool Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app" class="min-h-screen p-8">
        
        <header class="mb-10 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-indigo-700">Financial Tool Dashboard</h1>
                <p class="text-gray-500">Upload, Map, and Generate Reports</p>
            </div>
            <div class="flex items-center space-x-4 bg-white p-3 rounded-lg shadow-sm">
                <label class="font-semibold text-sm text-gray-600">Active Work ID:</label>
                <input type="number" v-model="workId" class="border border-gray-300 rounded px-2 py-1 w-20 text-center focus:outline-none focus:border-indigo-500">
                <button @click="refreshData" class="text-indigo-600 hover:text-indigo-800" title="Refresh Data">
                    <i class="fas fa-sync-alt" :class="{'fa-spin': loading}"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="space-y-8">
                
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-file-upload mr-2"></i>1. Upload Trial Balance</h2>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition">
                        <input type="file" ref="fileInput" @change="handleFileSelect" class="hidden" accept=".csv">
                        <div v-if="!selectedFile">
                            <button @click="$refs.fileInput.click()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">
                                Select CSV File
                            </button>
                            <p class="text-xs text-gray-400 mt-2">Supports .csv files only</p>
                        </div>
                        <div v-else class="flex flex-col items-center">
                            <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded mb-3">{{ selectedFile.name }}</span>
                            <div class="flex space-x-2">
                                <button @click="uploadFile" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">
                                    <i class="fas fa-cloud-upload-alt mr-1"></i> Upload
                                </button>
                                <button @click="selectedFile = null" class="text-red-500 hover:text-red-700 text-sm">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-file-pdf mr-2"></i>3. Generate Reports</h2>
                    <div v-if="templates.length === 0" class="text-gray-400 text-sm italic">No templates found. Create one via API.</div>
                    <div v-else class="space-y-3">
                        <div v-for="template in templates" :key="template.id" class="flex justify-between items-center bg-gray-50 p-3 rounded border border-gray-200">
                            <div>
                                <div class="font-medium text-gray-800">{{ template.name }}</div>
                                <div class="text-xs text-gray-500">{{ template.statement_type }}</div>
                            </div>
                            <div class="flex space-x-2">
                                <button @click="downloadReport(template.id, 'pdf')" class="text-red-600 hover:bg-red-50 p-2 rounded" title="Download PDF">
                                    <i class="fas fa-file-pdf fa-lg"></i>
                                </button>
                                <button @click="downloadReport(template.id, 'xlsx')" class="text-green-600 hover:bg-green-50 p-2 rounded" title="Download Excel">
                                    <i class="fas fa-file-excel fa-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700"><i class="fas fa-random mr-2"></i>2. Map Entries</h2>
                        <span class="bg-indigo-100 text-indigo-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">{{ unmappedEntries.length }} Pending</span>
                    </div>

                    <div v-if="unmappedEntries.length === 0" class="flex-1 flex flex-col items-center justify-center text-gray-400 min-h-[300px]">
                        <i class="fas fa-check-circle text-5xl mb-4 text-green-100"></i>
                        <p>All items mapped! You are ready to generate reports.</p>
                    </div>

                    <div v-else class="flex-1 overflow-auto max-h-[600px] space-y-3 pr-2">
                        <div v-for="entry in unmappedEntries" :key="entry.id" class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-bold text-gray-800">{{ entry.account_name }}</h4>
                                    <span class="text-xs text-gray-500">ID: {{ entry.id }}</span>
                                </div>
                                <div class="text-right">
                                    <div class="font-mono font-bold" :class="entry.closing_balance >= 0 ? 'text-green-600' : 'text-red-600'">
                                        {{ formatCurrency(entry.closing_balance) }}
                                    </div>
                                    <div class="text-xs text-gray-400">Balance</div>
                                </div>
                            </div>
                            
                            <div class="flex space-x-2 mt-3">
                                <select v-model="entry.selectedAccountId" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                                    <option :value="null" disabled>Select standard account...</option>
                                    <option v-for="acc in subHeadAccounts" :key="acc.id" :value="acc.id">
                                        {{ acc.name }}
                                    </option>
                                </select>
                                <button 
                                    @click="mapEntry(entry)" 
                                    :disabled="!entry.selectedAccountId || entry.mapping" 
                                    class="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition"
                                >
                                    <i v-if="entry.mapping" class="fas fa-spinner fa-spin"></i>
                                    <span v-else>Map</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="toast.show" class="fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg text-white transition-opacity duration-500" 
             :class="toast.type === 'error' ? 'bg-red-600' : 'bg-green-600'">
            {{ toast.message }}
        </div>

    </div>

    <script>
        const API_URL = 'http://localhost:8000'; // Make sure this matches your backend

        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    workId: 1, // Default Work ID
                    loading: false,
                    selectedFile: null,
                    unmappedEntries: [],
                    accounts: [],
                    templates: [],
                    toast: { show: false, message: '', type: 'success' }
                }
            },
            computed: {
                // Filter only SUB_HEAD accounts for mapping
                subHeadAccounts() {
                    return this.accounts
                        .filter(acc => acc.type === 'SUB_HEAD')
                        .sort((a, b) => a.name.localeCompare(b.name));
                }
            },
            mounted() {
                this.refreshData();
            },
            methods: {
                async refreshData() {
                    this.loading = true;
                    try {
                        await Promise.all([
                            this.fetchAccounts(),
                            this.fetchUnmapped(),
                            this.fetchTemplates()
                        ]);
                    } catch (e) {
                        console.error(e);
                    } finally {
                        this.loading = false;
                    }
                },

                // --- API Calls ---

                async fetchAccounts() {
                    const res = await fetch(`${API_URL}/accounts/`);
                    this.accounts = await res.json();
                },

                async fetchUnmapped() {
                    try {
                        const res = await fetch(`${API_URL}/works/${this.workId}/unmapped-entries`);
                        if (!res.ok) throw new Error('Work not found');
                        const data = await res.json();
                        // Add local state for selection
                        this.unmappedEntries = data.map(e => ({...e, selectedAccountId: null, mapping: false}));
                    } catch (e) {
                        this.unmappedEntries = []; // Clear on error
                    }
                },

                async fetchTemplates() {
                    const res = await fetch(`${API_URL}/templates/`);
                    this.templates = await res.json();
                },

                // --- Actions ---

                handleFileSelect(event) {
                    this.selectedFile = event.target.files[0];
                },

                async uploadFile() {
                    if (!this.selectedFile) return;
                    
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);

                    try {
                        const res = await fetch(`${API_URL}/works/${this.workId}/trial-balance`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!res.ok) throw new Error('Upload failed');
                        
                        this.showToast('File uploaded successfully!');
                        this.selectedFile = null;
                        this.fetchUnmapped(); // Refresh list
                    } catch (e) {
                        this.showToast(e.message, 'error');
                    }
                },

                async mapEntry(entry) {
                    entry.mapping = true;
                    try {
                        const res = await fetch(`${API_URL}/works/${this.workId}/map-entry`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                trial_balance_entry_id: entry.id,
                                account_sub_head_id: entry.selectedAccountId
                            })
                        });

                        if (!res.ok) throw new Error('Mapping failed');

                        // Remove from list locally for instant feedback
                        this.unmappedEntries = this.unmappedEntries.filter(e => e.id !== entry.id);
                        this.showToast('Entry mapped successfully');
                    } catch (e) {
                        this.showToast(e.message, 'error');
                        entry.mapping = false;
                    }
                },

                downloadReport(templateId, format) {
                    const url = `${API_URL}/works/${this.workId}/statements/${templateId}?format=${format}`;
                    window.open(url, '_blank');
                },

                // --- Helpers ---

                showToast(msg, type = 'success') {
                    this.toast = { show: true, message: msg, type };
                    setTimeout(() => this.toast.show = false, 3000);
                },

                formatCurrency(value) {
                    return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(value);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>